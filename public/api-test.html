<!DOCTYPE html>
<html lang="ru" dir="ltr" data-nav-layout="vertical" data-theme-mode="light" data-header-styles="light" data-menu-styles="light" data-toggled="open">

<head>
    <!-- Meta Data -->
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API - WhatsApp Service</title>
    <meta name="Description" content="–°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è WhatsApp API">
    
    <!-- Favicon -->
    <link rel="icon" href="/bootstrap-theme/assets/images/brand-logos/favicon.ico" type="image/x-icon">
    
    <!-- Bootstrap Css -->
    <link id="style" href="/bootstrap-theme/assets/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Style Css -->
    <link href="/bootstrap-theme/assets/css/styles.min.css" rel="stylesheet">
    
    <!-- Icons Css -->
    <link href="/bootstrap-theme/assets/css/icons.css" rel="stylesheet">
    
    <!-- Node Waves Css -->
    <link href="/bootstrap-theme/assets/libs/node-waves/waves.min.css" rel="stylesheet">
    
    <!-- Simplebar Css -->
    <link href="/bootstrap-theme/assets/libs/simplebar/simplebar.min.css" rel="stylesheet">
    
    <!-- –û–±—â–µ–µ –º–µ–Ω—é -->
    <script src="/menu.js"></script>
    
    <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ WhatsApp -->
    <script src="/whatsapp-status.js"></script>
    
    <style>
        .app-sidebar {
            display: block !important;
            visibility: visible !important;
        }
        .main-menu {
            display: block !important;
        }
        .side-menu__item {
            display: flex !important;
            align-items: center !important;
            padding: 0.75rem 1.25rem !important;
            color: #495057 !important;
            text-decoration: none !important;
        }
        .side-menu__item:hover {
            background-color: #f8f9fa !important;
        }
        .side-menu__item.active {
            background-color: #e7f1ff !important;
            color: #0d6efd !important;
        }
        .side-menu__icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            fill: currentColor;
        }
        .side-menu__label {
            display: block !important;
        }
        .response-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .history-item {
            border-bottom: 1px solid #dee2e6;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-time {
            font-size: 0.75rem;
            color: #6c757d;
        }
        .example-btn {
            margin: 0.25rem;
        }
        .operation-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body>
    <!-- Loader -->
    <div id="loader">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Page -->
    <div class="page">
        <!-- App Header -->
        <div class="app-header header sticky" id="header">
            <div class="container-fluid main-container">
                <div class="d-flex">
                    <a aria-label="Hide Sidebar" class="app-sidebar-toggle" onclick="if(document.body.classList.contains('sidebar-minimize')) { document.body.classList.remove('sidebar-minimize'); } else { document.body.classList.add('sidebar-minimize'); }" id="sidebar-toggle"></a>
                    <div class="main-header-center ms-3 d-none d-md-flex">
                    </div>
                    <div class="d-flex order-lg-2 ms-auto header-right-icons">
                        <div class="me-2 d-sm-inline d-none">
                            <div id="whatsapp-status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /App Header -->

        <!-- Start::app-sidebar -->
        <aside class="app-sidebar sticky" id="sidebar">
            <div class="main-sidebar-header">
                <a href="/" class="header-logo">
                    <span class="desktop-logo">üì± WhatsApp</span>
                    <span class="toggle-logo">WA</span>
                </a>
            </div>
            <div class="main-sidebar" id="sidebar-scroll">
                <nav class="main-menu-container nav nav-pills flex-column sub-open">
                    <div class="slide-left" id="slide-left">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#7b8191" width="24" height="24" viewBox="0 0 24 24"> <path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"></path> </svg>
                    </div>
                    <ul class="main-menu" id="main-menu">
                        <!-- –ú–µ–Ω—é –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ menu.js -->
                    </ul>
                </nav>
            </div>
        </aside>
        <!-- End::app-sidebar -->

        <!-- Main Content -->
        <div class="main-content app-content">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WhatsApp API</h1>
                    <div>
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                            <li class="breadcrumb-item active">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API</li>
                        </ol>
                    </div>
                </div>
                <!-- /Page Header -->

                <!-- Row -->
                <div class="row">
                    <div class="col-xl-12">
                        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                            </div>
                            <div class="card-body">
                                <div id="connectionStatus">
                                    <span class="badge bg-secondary">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                                </div>
                            </div>
                        </div>

                        <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <div class="card operation-section">
                            <div class="card-header">
                                <h3 class="card-title">–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                            </div>
                            <div class="card-body">
                                <form id="sendMessageForm">
                                    <div class="mb-3">
                                        <label for="chatIdSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</label>
                                        <select class="form-select" id="chatIdSelect" required>
                                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</option>
                                        </select>
                                        <small class="form-text text-muted">–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID —á–∞—Ç–∞ –≤—Ä—É—á–Ω—É—é</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="chatIdInput" class="form-label">ID —á–∞—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–∑ —Å–ø–∏—Å–∫–∞)</label>
                                        <input type="text" class="form-control" id="chatIdInput" placeholder="120363123456789@g.us –∏–ª–∏ 5511999999999@c.us">
                                    </div>
                                    <div class="mb-3">
                                        <label for="messageText" class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                                        <textarea class="form-control" id="messageText" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..." required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-sm btn-outline-secondary example-btn" onclick="setExample('send-message-1')">–ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary example-btn" onclick="setExample('send-message-2')">–ü—Ä–∏–º–µ—Ä 2: –°–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary example-btn" onclick="setExample('send-message-3')">–ü—Ä–∏–º–µ—Ä 3: –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–µ</button>
                                    </div>
                                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                                </form>
                                <div class="mt-3">
                                    <h5>–û—Ç–≤–µ—Ç:</h5>
                                    <div id="sendMessageResponse" class="response-container" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–∞—Ö -->
                        <div class="card operation-section">
                            <div class="card-header">
                                <h3 class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–∞—Ö</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary" onclick="getChats()">–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤</button>
                                    <button type="button" class="btn btn-secondary" onclick="clearResponse('getChatsResponse')">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                </div>
                                <div class="mb-3">
                                    <label for="chatInfoId" class="form-label">–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —á–∞—Ç–µ (ID)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="chatInfoId" placeholder="120363123456789@g.us">
                                        <button class="btn btn-primary" type="button" onclick="getChatInfo()">–ü–æ–ª—É—á–∏—Ç—å</button>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h5>–û—Ç–≤–µ—Ç:</h5>
                                    <div id="getChatsResponse" class="response-container" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —á–∞—Ç–∞ -->
                        <div class="card operation-section">
                            <div class="card-header">
                                <h3 class="card-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="messagesChatId" class="form-label">ID —á–∞—Ç–∞</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="messagesChatId" placeholder="120363123456789@g.us –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞">
                                        <select class="form-select" id="messagesChatIdSelect" style="max-width: 200px;" onchange="document.getElementById('messagesChatId').value = this.value">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç...</option>
                                        </select>
                                    </div>
                                    <small class="form-text text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é</small>
                                </div>
                                <div class="mb-3">
                                    <label for="messagesLimit" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π</label>
                                    <select class="form-select" id="messagesLimit">
                                        <option value="3" selected>3 (–ø–æ—Å–ª–µ–¥–Ω–∏–µ)</option>
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary" onclick="getChatMessages()">–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</button>
                                    <button type="button" class="btn btn-secondary" onclick="clearResponse('getChatMessagesResponse')">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                </div>
                                <div class="mt-3">
                                    <h5>–û—Ç–≤–µ—Ç:</h5>
                                    <div id="getChatMessagesResponse" class="response-container" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö -->
                        <div class="card operation-section">
                            <div class="card-header">
                                <h3 class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary" onclick="getContacts()">–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</button>
                                    <button type="button" class="btn btn-secondary" onclick="clearResponse('getContactsResponse')">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                </div>
                                <div class="mt-3">
                                    <h5>–û—Ç–≤–µ—Ç:</h5>
                                    <div id="getContactsResponse" class="response-container" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
                        <div class="card operation-section">
                            <div class="card-header">
                                <h3 class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary" onclick="getClientInfo()">–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ</button>
                                    <button type="button" class="btn btn-secondary" onclick="clearResponse('getClientInfoResponse')">–û—á–∏—Å—Ç–∏—Ç—å</button>
                                </div>
                                <div class="mt-3">
                                    <h5>–û—Ç–≤–µ—Ç:</h5>
                                    <div id="getClientInfoResponse" class="response-container" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
                                <div class="card-options">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearHistory()">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="requestHistory" style="max-height: 500px; overflow-y: auto;">
                                    <p class="text-muted">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /Row -->
            </div>
        </div>
        <!-- /Main Content -->

        <!-- Footer -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row align-items-center flex-row-reverse">
                    <div class="col-md-12 col-sm-12 text-center">
                        Copyright ¬© 2025 <a href="#">WhatsApp Service</a>. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
                    </div>
                </div>
            </div>
        </footer>
        <!-- /Footer -->
    </div>
    <!-- /Page -->

    <!-- Back-to-top -->
    <a href="#top" id="back-to-top"><i class="ri-arrow-up-line"></i></a>

    <!-- Scripts -->
    <script src="/bootstrap-theme/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/simplebar/simplebar.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/node-waves/waves.min.js"></script>
    <script src="/bootstrap-theme/assets/js/sticky.js"></script>
    <script src="/bootstrap-theme/assets/js/custom.js"></script>
    <script src="/bootstrap-theme/assets/js/defaultmenu.min.js"></script>
    <script src="/bootstrap-theme/assets/js/sidebar-menu.js"></script>
    <script src="/bootstrap-theme/assets/js/custom-switcher.min.js"></script>

    <!-- API Test Script -->
    <script>
        // –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
        let requestHistory = [];

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function handleConnectionError(error) {
            if (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED')) {
                return {
                    message: '–°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ WhatsApp Service –Ω–∞ –ø–æ—Ä—Ç—É 3000.',
                    shouldLog: false
                };
            }
            return {
                message: error.message,
                shouldLog: true
            };
        }

        // –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤
        const examples = {
            'send-message-1': {
                message: '–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.'
            },
            'send-message-2': {
                message: '–ü—Ä–∏–≤–µ—Ç! üëã –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏ üòä'
            },
            'send-message-3': {
                message: '–ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:\n–°—Ç—Ä–æ–∫–∞ 1\n–°—Ç—Ä–æ–∫–∞ 2\n–°—Ç—Ä–æ–∫–∞ 3'
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            checkConnectionStatus();
            setInterval(checkConnectionStatus, 5000);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
            loadChats();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            const sendMessageForm = document.getElementById('sendMessageForm');
            if (sendMessageForm) {
                sendMessageForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await sendMessage();
                });
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function checkConnectionStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                
                const statusEl = document.getElementById('connectionStatus');
                if (statusEl) {
                    if (data.isReady) {
                        statusEl.innerHTML = '<span class="badge bg-success">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ</span>';
                    } else if (data.status === 'connecting') {
                        statusEl.innerHTML = '<span class="badge bg-warning">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>';
                    } else {
                        statusEl.innerHTML = `<span class="badge bg-danger">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ (${data.status})</span>`;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                const statusEl = document.getElementById('connectionStatus');
                if (statusEl) {
                    if (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED')) {
                        statusEl.innerHTML = '<span class="badge bg-danger">–°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω</span><br><small class="text-muted">–ó–∞–ø—É—Å—Ç–∏—Ç–µ WhatsApp Service –Ω–∞ –ø–æ—Ä—Ç—É 3000</small>';
                    } else {
                        statusEl.innerHTML = `<span class="badge bg-danger">–û—à–∏–±–∫–∞: ${error.message}</span>`;
                    }
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        async function loadChats() {
            try {
                const response = await fetch('/api/chats');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                
                const select = document.getElementById('chatIdSelect');
                const messagesSelect = document.getElementById('messagesChatIdSelect');
                
                const populateSelect = (selectElement) => {
                    if (!selectElement) return;
                    
                    selectElement.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç...</option>';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—ã
                    if (data.groups && data.groups.length > 0) {
                        const groupOpt = document.createElement('optgroup');
                        groupOpt.label = '–ì—Ä—É–ø–ø—ã';
                        data.groups.forEach(group => {
                            const option = document.createElement('option');
                            option.value = group.id;
                            option.textContent = `[–ì—Ä—É–ø–ø–∞] ${group.name}`;
                            groupOpt.appendChild(option);
                        });
                        selectElement.appendChild(groupOpt);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã
                    if (data.personalChats && data.personalChats.length > 0) {
                        const personalOpt = document.createElement('optgroup');
                        personalOpt.label = '–õ–∏—á–Ω—ã–µ —á–∞—Ç—ã';
                        data.personalChats.forEach(chat => {
                            const option = document.createElement('option');
                            option.value = chat.id;
                            option.textContent = `[–õ–∏—á–Ω—ã–π] ${chat.name}`;
                            personalOpt.appendChild(option);
                        });
                        selectElement.appendChild(personalOpt);
                    }
                };
                
                populateSelect(select);
                populateSelect(messagesSelect);
            } catch (error) {
                // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –ø—Ä–æ—Å—Ç–æ –Ω–µ –∑–∞–ø—É—â–µ–Ω
                if (!error.message.includes('Failed to fetch') && !error.message.includes('ERR_CONNECTION_REFUSED')) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                }
                const select = document.getElementById('chatIdSelect');
                const messagesSelect = document.getElementById('messagesChatIdSelect');
                const errorText = error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_REFUSED') 
                    ? '–°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω' 
                    : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤';
                if (select) {
                    select.innerHTML = `<option value="">${errorText}</option>`;
                }
                if (messagesSelect) {
                    messagesSelect.innerHTML = `<option value="">${errorText}</option>`;
                }
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const chatIdSelect = document.getElementById('chatIdSelect');
            const chatIdInput = document.getElementById('chatIdInput');
            const messageText = document.getElementById('messageText');
            const responseEl = document.getElementById('sendMessageResponse');
            
            const chatId = chatIdSelect?.value || chatIdInput?.value;
            const message = messageText?.value;
            
            if (!chatId) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å ID —á–∞—Ç–∞');
                return;
            }
            
            if (!message) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            try {
                addToHistory('POST', '/api/test/send-message', { chatId, message });
                
                const response = await fetch('/api/test/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({ chatId, message })
                });
                
                const data = await response.json();
                
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = JSON.stringify(data, null, 2);
                }
                
                addToHistory('POST', '/api/test/send-message', { chatId, message }, data, response.status);
                
            } catch (error) {
                const errorInfo = handleConnectionError(error);
                if (errorInfo.shouldLog) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                }
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = `–û—à–∏–±–∫–∞: ${errorInfo.message}`;
                }
                addToHistory('POST', '/api/test/send-message', { chatId, message }, { error: errorInfo.message }, 500);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        async function getChats() {
            const responseEl = document.getElementById('getChatsResponse');
            
            try {
                addToHistory('GET', '/api/chats', null);
                
                const response = await fetch('/api/chats');
                const data = await response.json();
                
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = JSON.stringify(data, null, 2);
                }
                
                addToHistory('GET', '/api/chats', null, data, response.status);
                
            } catch (error) {
                const errorInfo = handleConnectionError(error);
                if (errorInfo.shouldLog) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Ç–æ–≤:', error);
                }
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = `–û—à–∏–±–∫–∞: ${errorInfo.message}`;
                }
                addToHistory('GET', '/api/chats', null, { error: errorInfo.message }, 500);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —á–∞—Ç–µ
        async function getChatInfo() {
            const chatIdInput = document.getElementById('chatInfoId');
            const responseEl = document.getElementById('getChatsResponse');
            
            const chatId = chatIdInput?.value;
            
            if (!chatId) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å ID —á–∞—Ç–∞');
                return;
            }
            
            try {
                addToHistory('GET', `/api/test/chat/${chatId}`, null);
                
                const response = await fetch(`/api/test/chat/${encodeURIComponent(chatId)}`);
                const data = await response.json();
                
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = JSON.stringify(data, null, 2);
                }
                
                addToHistory('GET', `/api/test/chat/${chatId}`, null, data, response.status);
                
            } catch (error) {
                const errorInfo = handleConnectionError(error);
                if (errorInfo.shouldLog) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ:', error);
                }
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = `–û—à–∏–±–∫–∞: ${errorInfo.message}`;
                }
                addToHistory('GET', `/api/test/chat/${chatId}`, null, { error: errorInfo.message }, 500);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
        async function getContacts() {
            const responseEl = document.getElementById('getContactsResponse');
            
            try {
                addToHistory('GET', '/api/test/contacts', null);
                
                const response = await fetch('/api/test/contacts');
                const data = await response.json();
                
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = JSON.stringify(data, null, 2);
                }
                
                addToHistory('GET', '/api/test/contacts', null, data, response.status);
                
            } catch (error) {
                const errorInfo = handleConnectionError(error);
                if (errorInfo.shouldLog) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', error);
                }
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = `–û—à–∏–±–∫–∞: ${errorInfo.message}`;
                }
                addToHistory('GET', '/api/test/contacts', null, { error: errorInfo.message }, 500);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ
        async function getClientInfo() {
            const responseEl = document.getElementById('getClientInfoResponse');
            
            try {
                addToHistory('GET', '/api/test/client-info', null);
                
                const response = await fetch('/api/test/client-info');
                const data = await response.json();
                
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = JSON.stringify(data, null, 2);
                }
                
                addToHistory('GET', '/api/test/client-info', null, data, response.status);
                
            } catch (error) {
                const errorInfo = handleConnectionError(error);
                if (errorInfo.shouldLog) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ:', error);
                }
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = `–û—à–∏–±–∫–∞: ${errorInfo.message}`;
                }
                addToHistory('GET', '/api/test/client-info', null, { error: errorInfo.message }, 500);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —á–∞—Ç–∞
        async function getChatMessages() {
            const chatIdInput = document.getElementById('messagesChatId');
            const messagesSelect = document.getElementById('messagesChatIdSelect');
            const limitSelect = document.getElementById('messagesLimit');
            const responseEl = document.getElementById('getChatMessagesResponse');
            
            const chatId = chatIdInput?.value || messagesSelect?.value;
            const limit = limitSelect?.value || '3';
            
            if (!chatId) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å ID —á–∞—Ç–∞');
                return;
            }
            
            try {
                const url = `/api/test/chat/${encodeURIComponent(chatId)}/messages?limit=${limit}`;
                addToHistory('GET', url, { chatId, limit });
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = JSON.stringify(data, null, 2);
                }
                
                addToHistory('GET', url, { chatId, limit }, data, response.status);
                
            } catch (error) {
                const errorInfo = handleConnectionError(error);
                if (errorInfo.shouldLog) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                }
                if (responseEl) {
                    responseEl.style.display = 'block';
                    responseEl.textContent = `–û—à–∏–±–∫–∞: ${errorInfo.message}`;
                }
                addToHistory('GET', `/api/test/chat/${chatId}/messages`, { chatId, limit }, { error: errorInfo.message }, 500);
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–º–µ—Ä–∞
        function setExample(exampleId) {
            const example = examples[exampleId];
            if (example) {
                const messageText = document.getElementById('messageText');
                if (messageText) {
                    messageText.value = example.message;
                }
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
        function clearResponse(responseId) {
            const responseEl = document.getElementById(responseId);
            if (responseEl) {
                responseEl.style.display = 'none';
                responseEl.textContent = '';
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        function addToHistory(method, url, request, response, status) {
            const historyItem = {
                timestamp: new Date().toISOString(),
                method: method,
                url: url,
                request: request,
                response: response,
                status: status
            };
            
            requestHistory.unshift(historyItem);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 50 –∑–∞–ø–∏—Å—è–º–∏
            if (requestHistory.length > 50) {
                requestHistory = requestHistory.slice(0, 50);
            }
            
            updateHistoryDisplay();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
        function updateHistoryDisplay() {
            const historyEl = document.getElementById('requestHistory');
            if (!historyEl) return;
            
            if (requestHistory.length === 0) {
                historyEl.innerHTML = '<p class="text-muted">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>';
                return;
            }
            
            let html = '';
            requestHistory.forEach((item, index) => {
                const time = new Date(item.timestamp).toLocaleString('ru-RU');
                const statusClass = item.status >= 200 && item.status < 300 ? 'success' : 'danger';
                
                html += `
                    <div class="history-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-${statusClass} me-2">${item.status || 'N/A'}</span>
                                    <strong>${item.method}</strong>
                                    <span class="ms-2 text-muted">${item.url}</span>
                                </div>
                                <div class="history-time">${time}</div>
                                ${item.request ? `<div class="mt-2"><strong>–ó–∞–ø—Ä–æ—Å:</strong><pre class="mb-0" style="font-size: 0.75rem;">${JSON.stringify(item.request, null, 2)}</pre></div>` : ''}
                                ${item.response ? `<div class="mt-2"><strong>–û—Ç–≤–µ—Ç:</strong><pre class="mb-0" style="font-size: 0.75rem; max-height: 200px; overflow-y: auto;">${JSON.stringify(item.response, null, 2)}</pre></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyEl.innerHTML = html;
        }

        // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        function clearHistory() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤?')) {
                requestHistory = [];
                updateHistoryDisplay();
            }
        }
    </script>
</body>

</html>

