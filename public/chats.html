<!DOCTYPE html>
<html lang="ru" dir="ltr" data-nav-layout="vertical" data-theme-mode="light" data-header-styles="light" data-menu-styles="light" data-toggled="open">

<head>
    <!-- Meta Data -->
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>–ß–∞—Ç—ã - WhatsApp Service</title>
    <meta name="Description" content="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏ WhatsApp">
    
    <!-- Favicon -->
    <link rel="icon" href="/bootstrap-theme/assets/images/brand-logos/favicon.ico" type="image/x-icon">
    
    <!-- Bootstrap Css -->
    <link id="style" href="/bootstrap-theme/assets/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Style Css -->
    <link href="/bootstrap-theme/assets/css/styles.min.css" rel="stylesheet">
    
    <!-- Icons Css -->
    <link href="/bootstrap-theme/assets/css/icons.css" rel="stylesheet">
    
    <!-- Node Waves Css -->
    <link href="/bootstrap-theme/assets/libs/node-waves/waves.min.css" rel="stylesheet">
    
    <!-- Simplebar Css -->
    <link href="/bootstrap-theme/assets/libs/simplebar/simplebar.min.css" rel="stylesheet">
    
    <!-- –û–±—â–µ–µ –º–µ–Ω—é -->
    <script src="/menu.js"></script>
    
    <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ WhatsApp -->
    <script src="/whatsapp-status.js"></script>
    
    <!-- Fix for missing DOM elements - MUST be before other scripts -->
    <script>
        // Global error handler to prevent script errors from breaking the page
        window.addEventListener('error', function(e) {
            const errorMessage = e.message || '';
            const errorFilename = e.filename || '';
            
            if (errorMessage.includes('Cannot read properties of null') ||
                errorMessage.includes('classList') ||
                errorMessage.includes('addEventListener') ||
                errorMessage.includes('appendChild') ||
                errorFilename.includes('defaultmenu.min.js') ||
                errorFilename.includes('custom-switcher.min.js') ||
                errorFilename.includes('custom.js')) {
                e.preventDefault();
                e.stopPropagation();
                return true;
            }
        }, true);
        
        // Ensure all required DOM elements exist before scripts execute
        (function() {
            let isEnsuring = false;
            
            window.ensureElements = function ensureElements() {
                if (isEnsuring) return;
                isEnsuring = true;
                
                try {
                    if (!document.getElementById('loader')) {
                        const loader = document.createElement('div');
                        loader.id = 'loader';
                        loader.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                        loader.style.display = 'none';
                        document.body.appendChild(loader);
                    }
                    
                    if (!document.querySelector('.horizontal-menu')) {
                        const headerContainer = document.querySelector('.main-header-container');
                        if (headerContainer) {
                            const headerCenter = document.createElement('div');
                            headerCenter.className = 'main-header-center d-none d-lg-block';
                            headerCenter.style.display = 'none';
                            const horizontalMenu = document.createElement('nav');
                            horizontalMenu.className = 'horizontal-menu';
                            const ul = document.createElement('ul');
                            ul.className = 'horizontal-list';
                            horizontalMenu.appendChild(ul);
                            headerCenter.appendChild(horizontalMenu);
                            headerContainer.appendChild(headerCenter);
                        }
                    }
                    
                    if (!document.getElementById('switcher-canvas')) {
                        const switcher = document.createElement('div');
                        switcher.className = 'offcanvas offcanvas-end';
                        switcher.id = 'switcher-canvas';
                        switcher.setAttribute('tabindex', '-1');
                        switcher.setAttribute('aria-labelledby', 'offcanvasRightLabel');
                        switcher.innerHTML = '<div class="offcanvas-header border-bottom"><h5 class="offcanvas-title text-default" id="offcanvasRightLabel">Switcher</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button></div><div class="offcanvas-body"></div>';
                        document.body.appendChild(switcher);
                    }
                    
                    if (!document.getElementById('header-sidebar')) {
                        const headerSidebar = document.createElement('div');
                        headerSidebar.className = 'offcanvas offcanvas-end';
                        headerSidebar.id = 'header-sidebar';
                        headerSidebar.setAttribute('tabindex', '-1');
                        headerSidebar.setAttribute('aria-labelledby', 'sidebarLabel');
                        headerSidebar.innerHTML = '<div class="offcanvas-header rounded-0"><h5 class="fs-14 text-uppercase mb-0 fw-semibold" id="sidebarLabel">–ú–µ–Ω—é</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button></div><div class="offcanvas-body rounded-0 p-0"></div>';
                        document.body.appendChild(headerSidebar);
                    }
                    
                    if (!document.querySelector('.scrollToTop')) {
                        const scrollToTop = document.createElement('div');
                        scrollToTop.className = 'scrollToTop';
                        scrollToTop.innerHTML = '<span class="arrow"><i class="las la-angle-double-up"></i></span>';
                        document.body.appendChild(scrollToTop);
                    }
                    
                    if (!document.getElementById('responsive-overlay')) {
                        const overlay = document.createElement('div');
                        overlay.id = 'responsive-overlay';
                        document.body.appendChild(overlay);
                    }
                    
                    const loader = document.getElementById('loader');
                    if (loader) {
                        loader.style.display = 'none';
                    }
                } catch (e) {
                    console.warn('Error in ensureElements:', e);
                } finally {
                    isEnsuring = false;
                }
            };
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    window.ensureElements();
                    setTimeout(window.ensureElements, 100);
                });
            } else {
                window.ensureElements();
                setTimeout(window.ensureElements, 100);
            }
        })();
    </script>
    
    <style>
        .app-sidebar {
            display: block !important;
            visibility: visible !important;
        }
        .main-menu {
            display: block !important;
        }
        .side-menu__item {
            display: flex !important;
            align-items: center !important;
            padding: 0.75rem 1.25rem !important;
            color: #495057 !important;
            text-decoration: none !important;
        }
        .side-menu__item:hover {
            background-color: #f8f9fa !important;
        }
        .side-menu__item.active {
            background-color: #e7f1ff !important;
            color: #0d6efd !important;
        }
        .side-menu__icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            fill: currentColor;
        }
        .side-menu__label {
            display: block !important;
        }
    </style>
</head>

<body>
    <!-- Page Loader -->
    <div id="loader" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <!-- Page Loader -->

    <!-- Start Switcher -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="switcher-canvas" aria-labelledby="offcanvasRightLabel">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title text-default" id="offcanvasRightLabel">Switcher</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <p>Switcher content</p>
        </div>
    </div>
    <!-- End Switcher -->
    
    <div class="page">
        <!-- app-header -->
        <header class="app-header">
            <div class="main-header-container container-fluid">
                <div class="header-content-left">
                    <div class="header-element">
                        <a aria-label="Toggle Sidebar" class="sidemenu-toggle header-link animated-arrow hor-toggle horizontal-navtoggle" data-bs-toggle="sidebar" href="javascript:void(0);">
                            <i class="header-icon fe fe-align-left"></i>
                        </a>
                        <div class="main-header-center d-none d-lg-block" style="display: none !important;">
                            <nav class="horizontal-menu">
                                <ul class="horizontal-list"></ul>
                            </nav>
                        </div>
                    </div>
                    <div class="header-element">
                        <div class="horizontal-logo">
                            <a href="/" class="header-logo">
                                <span class="desktop-logo">üì± WhatsApp Service</span>
                                <span class="toggle-logo">WhatsApp</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="header-content-right">
                    <div class="header-element">
                        <span class="badge bg-success" id="serviceStatusBadge">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                    </div>
                </div>
            </div>
        </header>
        <!-- /app-header -->

        <!-- Start::app-sidebar -->
        <aside class="app-sidebar sticky" id="sidebar">
            <div class="main-sidebar-header">
                <a href="/" class="header-logo">
                    <span class="desktop-logo">üì± WhatsApp</span>
                    <span class="toggle-logo">WA</span>
                </a>
            </div>
            <div class="main-sidebar" id="sidebar-scroll">
                <nav class="main-menu-container nav nav-pills flex-column sub-open">
                    <div class="slide-left" id="slide-left">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="#7b8191" width="24" height="24" viewBox="0 0 24 24"> <path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"></path> </svg>
                    </div>
                    <ul class="main-menu" id="main-menu">
                        <!-- –ú–µ–Ω—é –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ menu.js -->
                    </ul>
                </nav>
            </div>
        </aside>
        <!-- End::app-sidebar -->

        <!--APP-CONTENT START-->
        <div class="main-content app-content">
            <div class="container-fluid">
                <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb">
                    <div class="my-auto">
                        <h5 class="page-title fs-21 mb-1">–ß–∞—Ç—ã</h5>
                        <nav>
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                                <li class="breadcrumb-item active" aria-current="page">–ß–∞—Ç—ã</li>
                            </ol>
                        </nav>
                    </div>
                </div>
                
                <!-- –ó–∞–¥–∞–Ω–∏—è -->
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card custom-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="card-title">
                                    <i class="fe fe-list me-2"></i>–ó–∞–¥–∞–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="showAddTaskModal()">
                                    <i class="fe fe-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                                </button>
                            </div>
                            <div class="card-body" style="min-width: 100%; width: 100%;">
                                <div id="tasksList" style="width: 100%; min-width: 100%;">
                                    <div class="text-center text-muted p-3">
                                        <span class="loading"></span> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card custom-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div class="card-title">
                                    <i class="fe fe-users me-2"></i>–°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshChats(false)" title="–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ –∫—ç—à–∞ (–±—ã—Å—Ç—Ä–æ)">
                                    <i class="fe fe-refresh-cw me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="refreshChats(true)" title="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞">
                                    <i class="fe fe-refresh-cw me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="showTestMessageModal()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                                    <i class="fe fe-send me-1"></i>–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                </button>
                            </div>
                            <div class="card-body" style="min-width: 100%;">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="chatSearchInput" 
                                           placeholder="–ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø..." oninput="filterChats()" style="width: 100%;">
                                </div>
                                <div id="chatsList" style="max-height: 600px; overflow-y: auto; width: 100%; min-width: 100%;">
                                    <div class="text-center text-muted p-3">
                                        <span class="loading"></span> –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Start -->
        <footer class="footer mt-auto py-4 bg-white">
            <div class="container-fluid">
                <div class="text-center">
                    <span class="text-muted">WhatsApp Service &copy; 2025</span>
                </div>
            </div>
        </footer>
        <!-- Footer End -->
    </div>

    <!-- Scroll To Top -->
    <div class="scrollToTop">
        <span class="arrow"><i class="las la-angle-double-up"></i></span>
    </div>
    <div id="responsive-overlay"></div>
    <!-- Scroll To Top -->

    <!-- Popper JS -->
    <script src="/bootstrap-theme/assets/libs/@popperjs/core/umd/popper.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/node-waves/waves.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/simplebar/simplebar.min.js"></script>
    <!-- Custom JS –¥–ª—è —Ä–∞–±–æ—Ç—ã –º–µ–Ω—é -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.ensureElements === 'function') {
                window.ensureElements();
                setTimeout(window.ensureElements, 200);
                setTimeout(window.ensureElements, 500);
            }
            
            setTimeout(function() {
                const scripts = [
                    '/bootstrap-theme/assets/js/defaultmenu.min.js',
                    '/bootstrap-theme/assets/js/custom-switcher.min.js',
                    '/bootstrap-theme/assets/js/custom.js'
                ];
                
                scripts.forEach(function(src) {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onerror = function() {};
                    document.body.appendChild(script);
                });
            }, 300);
        });

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç–∞–º–∏ –∏ –∑–∞–¥–∞–Ω–∏—è–º–∏
        let allChats = [];
        let selectedChatIds = new Set();
        let availablePrompts = [];
        let tasks = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤
        async function refreshChats(force = false) {
            const startTime = performance.now();
            console.log('‚ïê'.repeat(80));
            console.log('üîÑ –ù–ê–ß–ê–õ–û –ó–ê–ì–†–£–ó–ö–ò –ß–ê–¢–û–í');
            console.log('‚ïê'.repeat(80));
            console.log('‚è∞ –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:', new Date().toISOString());
            
            try {
                console.log('üìã –®–ê–ì 1: –ü–æ–∏—Å–∫ —ç–ª–µ–º–µ–Ω—Ç–∞ chatsList...');
                const container = document.getElementById('chatsList');
                if (!container) {
                    console.error('‚ùå –≠–õ–ï–ú–ï–ù–¢ chatsList –ù–ï –ù–ê–ô–î–ï–ù!');
                    console.error('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DOM:');
                    console.error('   - document.body:', document.body ? '—Å—É—â–µ—Å—Ç–≤—É–µ—Ç' : '–ù–ï –°–£–©–ï–°–¢–í–£–ï–¢');
                    console.error('   - document.getElementById("chatsList"):', document.getElementById('chatsList'));
                    return;
                }
                console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç chatsList –Ω–∞–π–¥–µ–Ω:', {
                    tagName: container.tagName,
                    id: container.id,
                    className: container.className,
                    innerHTML: container.innerHTML.substring(0, 100) + '...'
                });
                
                console.log('üìã –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏...');
                container.innerHTML = '<div class="text-center text-muted p-3"><span class="loading"></span> –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</div>';
                console.log('‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                
                console.log('üìã –®–ê–ì 3: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ /api/chats...');
                const fetchStartTime = performance.now();
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (120 —Å–µ–∫—É–Ω–¥ - –æ–±—Ä–∞–±–æ—Ç–∫–∞ 516 —á–∞—Ç–æ–≤ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.error('‚ùå –¢–ê–ô–ú–ê–£–¢: –ó–∞–ø—Ä–æ—Å –∫ /api/chats –ø—Ä–µ–≤—ã—Å–∏–ª 120 —Å–µ–∫—É–Ω–¥');
                }, 120000);
                
                let response;
                let data; // –û–±—ä—è–≤–ª—è–µ–º data –≤–Ω–µ try, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –±–ª–æ–∫–∞
                let fetchDuration = 0; // –û–±—ä—è–≤–ª—è–µ–º fetchDuration –≤–Ω–µ try
                let parseDuration = 0; // –û–±—ä—è–≤–ª—è–µ–º parseDuration –≤–Ω–µ try
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä force –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
                    const apiUrl = force ? '/api/chats?force=true' : '/api/chats';
                    
                    console.log('üì° –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ fetch...');
                    console.log('üìã URL –∑–∞–ø—Ä–æ—Å–∞: ' + apiUrl);
                    console.log('üìã –ú–µ—Ç–æ–¥: GET');
                    console.log('üìã –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ' + (force ? '–î–ê' : '–ù–ï–¢ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à)'));
                    console.log('üìã –¢–∞–π–º–∞—É—Ç: 120 —Å–µ–∫—É–Ω–¥');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
                    const progressInterval = setInterval(() => {
                        const elapsed = (performance.now() - fetchStartTime) / 1000;
                        console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞... (–ø—Ä–æ—à–ª–æ ${elapsed.toFixed(1)} —Å–µ–∫—É–Ω–¥)`);
                    }, 5000);
                    
                    response = await fetch(apiUrl, {
                        signal: controller.signal,
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    clearInterval(progressInterval);
                    clearTimeout(timeoutId);
                    fetchDuration = performance.now() - fetchStartTime;
                    console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç: HTTP ${response.status} ${response.statusText}`);
                    console.log(`‚è±Ô∏è –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: ${fetchDuration.toFixed(2)}–º—Å`);
                    
                    data = await response.json();
                    console.log('üìã –î–µ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç–∞:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok,
                        cached: data.cached || false,
                        cacheAge: data.cacheAge ? `${(data.cacheAge / 1000).toFixed(1)} —Å–µ–∫` : 'N/A',
                        groupsCount: data.groups?.length || 0,
                        personalChatsCount: data.personalChats?.length || 0
                    });
                    
                    if (data.cached) {
                        console.log(`üíæ –î–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ (–≤–æ–∑—Ä–∞—Å—Ç: ${data.cacheAge ? (data.cacheAge / 1000).toFixed(1) : 'N/A'} —Å–µ–∫)`);
                    } else {
                        console.log(`üîÑ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ (–∫—ç—à –æ–±–Ω–æ–≤–ª–µ–Ω)`);
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    const fetchDuration = performance.now() - fetchStartTime;
                    console.error('‚ùå –û–®–ò–ë–ö–ê –ü–†–ò –í–´–ü–û–õ–ù–ï–ù–ò–ò FETCH:', fetchError);
                    console.error(`‚è±Ô∏è –í—Ä–µ–º—è –¥–æ –æ—à–∏–±–∫–∏: ${fetchDuration.toFixed(2)}–º—Å`);
                    console.error('üìã –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
                        name: fetchError.name,
                        message: fetchError.message,
                        stack: fetchError.stack,
                        isAbortError: fetchError.name === 'AbortError'
                    });
                    
                    if (fetchError.name === 'AbortError') {
                        console.error('‚ùå –ó–ê–ü–†–û–° –ü–†–ï–†–í–ê–ù: –ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç 120 —Å–µ–∫—É–Ω–¥');
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞</strong><br>
                                –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –ø—Ä–µ–≤—ã—Å–∏–ª 120 —Å–µ–∫—É–Ω–¥. –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö (${allChats.length || '–º–Ω–æ–≥–æ'} —á–∞—Ç–æ–≤).<br>
                                <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ.</small><br>
                                <button class="btn btn-sm btn-primary mt-2" onclick="refreshChats()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
                            </div>
                        `;
                        return;
                    }
                    
                    throw fetchError;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå –û—à–∏–±–∫–∞ HTTP ${response.status}:`, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // JSON —É–∂–µ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω –≤—ã—à–µ
                console.log('üìã –®–ê–ì 4: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã');
                parseDuration = performance.now() - fetchStartTime; // –í—Ä–µ–º—è –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥
                
                console.log('üìã –®–ê–ì 5: –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
                console.log('üìä –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•:', {
                    hasGroups: Array.isArray(data.groups),
                    groupsLength: data.groups?.length || 0,
                    hasPersonalChats: Array.isArray(data.personalChats),
                    personalChatsLength: data.personalChats?.length || 0,
                    status: data.status,
                    hasError: !!data.error,
                    error: data.error,
                    total: data.total,
                    allKeys: Object.keys(data)
                });
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                if (!data.groups && !data.personalChats) {
                    console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –í –æ—Ç–≤–µ—Ç–µ –Ω–µ—Ç –º–∞—Å—Å–∏–≤–æ–≤ groups –∏ personalChats');
                    console.error('üìã –ü–û–õ–ù–´–ô –û–¢–í–ï–¢:', JSON.stringify(data, null, 2));
                    console.error('üìã –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:', typeof data);
                    console.error('üìã –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–∞—Å—Å–∏–≤–æ–º:', Array.isArray(data));
                } else {
                    console.log('‚úÖ –ú–∞—Å—Å–∏–≤—ã groups –∏ personalChats –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç');
                    if (data.groups && data.groups.length > 0) {
                        console.log('üìã –ü–µ—Ä–≤–∞—è –≥—Ä—É–ø–ø–∞:', data.groups[0]);
                    }
                    if (data.personalChats && data.personalChats.length > 0) {
                        console.log('üìã –ü–µ—Ä–≤—ã–π –ª–∏—á–Ω—ã–π —á–∞—Ç:', data.personalChats[0]);
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                if (data.error) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç API:', data.error);
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è ${escapeHtml(data.error)}</strong><br>
                            <small>–°—Ç–∞—Ç—É—Å: ${escapeHtml(data.status || 'unknown')}</small><br>
                            <button class="btn btn-sm btn-primary mt-2" onclick="refreshChats()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
                        </div>
                    `;
                    return;
                }
                
                console.log('üìã –®–ê–ì 6: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä—É–ø–ø...');
                const groupsStartTime = performance.now();
                const allGroups = (data.groups || []).map((chat, index) => {
                    const result = {
                        ...chat,
                        type: 'group',
                        selected: selectedChatIds.has(chat.id)
                    };
                    if (index < 3) {
                        console.log(`   –ì—Ä—É–ø–ø–∞ ${index + 1}:`, result);
                    }
                    return result;
                });
                const groupsDuration = performance.now() - groupsStartTime;
                console.log(`‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≥—Ä—É–ø–ø: ${allGroups.length} –∑–∞ ${groupsDuration.toFixed(2)}–º—Å`);
                
                console.log('üìã –®–ê–ì 7: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤...');
                const personalStartTime = performance.now();
                const allPersonal = (data.personalChats || []).map((chat, index) => {
                    const result = {
                        ...chat,
                        type: 'personal',
                        selected: selectedChatIds.has(chat.id)
                    };
                    if (index < 3) {
                        console.log(`   –õ–∏—á–Ω—ã–π —á–∞—Ç ${index + 1}:`, result);
                    }
                    return result;
                });
                const personalDuration = performance.now() - personalStartTime;
                console.log(`‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤: ${allPersonal.length} –∑–∞ ${personalDuration.toFixed(2)}–º—Å`);
                
                console.log('üìã –®–ê–ì 8: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —á–∞—Ç–æ–≤...');
                allChats = [...allGroups, ...allPersonal];
                console.log(`‚úÖ –í—Å–µ–≥–æ —á–∞—Ç–æ–≤ –≤ allChats: ${allChats.length}`);
                console.log(`üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –ì—Ä—É–ø–ø: ${allGroups.length}, –õ–∏—á–Ω—ã—Ö: ${allPersonal.length}`);
                
                if (allChats.length === 0) {
                    console.warn('‚ÑπÔ∏è –ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <strong>‚ÑπÔ∏è –ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</strong><br>
                            <small>–°—Ç–∞—Ç—É—Å: ${escapeHtml(data.status || 'unknown')}</small><br>
                            <button class="btn btn-sm btn-primary mt-2" onclick="refreshChats()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
                        </div>
                    `;
                    return;
                }
                
                console.log('üìã –®–ê–ì 9: –í—ã–∑–æ–≤ displayChats()...');
                const displayStartTime = performance.now();
                displayChats();
                const displayDuration = performance.now() - displayStartTime;
                console.log(`‚úÖ displayChats() –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∑–∞ ${displayDuration.toFixed(2)}–º—Å`);
                
                const totalDuration = performance.now() - startTime;
                console.log('‚ïê'.repeat(80));
                console.log('‚úÖ –ó–ê–ì–†–£–ó–ö–ê –ß–ê–¢–û–í –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û');
                console.log('‚ïê'.repeat(80));
                console.log(`‚è±Ô∏è –û–±—â–µ–µ –≤—Ä–µ–º—è: ${totalDuration.toFixed(2)}–º—Å`);
                console.log(`   - –ó–∞–ø—Ä–æ—Å: ${fetchDuration.toFixed(2)}–º—Å`);
                console.log(`   - –ü–∞—Ä—Å–∏–Ω–≥: ${parseDuration.toFixed(2)}–º—Å`);
                console.log(`   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä—É–ø–ø: ${groupsDuration.toFixed(2)}–º—Å`);
                console.log(`   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—á–Ω—ã—Ö: ${personalDuration.toFixed(2)}–º—Å`);
                console.log(`   - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${displayDuration.toFixed(2)}–º—Å`);
                console.log(`üìä –ò—Ç–æ–≥–æ —á–∞—Ç–æ–≤: ${allChats.length} (–ì—Ä—É–ø–ø: ${allGroups.length}, –õ–∏—á–Ω—ã—Ö: ${allPersonal.length})`);
                console.log('‚ïê'.repeat(80));
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                console.error('Stack trace:', error.stack);
                const container = document.getElementById('chatsList');
                if (container) {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤</strong><br>
                            ${escapeHtml(error.message)}<br>
                            <button class="btn btn-sm btn-primary mt-2" onclick="refreshChats()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
                        </div>
                    `;
                }
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–∞—Ç–æ–≤
        function displayChats() {
            const displayStartTime = performance.now();
            console.log('‚ïê'.repeat(80));
            console.log('üìù –ù–ê–ß–ê–õ–û –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ß–ê–¢–û–í');
            console.log('‚ïê'.repeat(80));
            try {
                console.log(`üìä –í—Å–µ–≥–æ —á–∞—Ç–æ–≤ –≤ allChats: ${allChats.length}`);
                console.log(`üìä –¢–∏–ø allChats:`, Array.isArray(allChats) ? '–º–∞—Å—Å–∏–≤' : typeof allChats);
                if (allChats.length > 0) {
                    console.log(`üìä –ü–µ—Ä–≤—ã–π —á–∞—Ç:`, allChats[0]);
                    console.log(`üìä –ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Ç:`, allChats[allChats.length - 1]);
                }
                
                const searchInput = document.getElementById('chatSearchInput');
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                console.log(`üîç –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: "${searchTerm}"`);
                
                const filteredChats = allChats.filter(chat => {
                    if (!chat || !chat.name) {
                        console.warn('‚ö†Ô∏è –ù–∞–π–¥–µ–Ω —á–∞—Ç –±–µ–∑ –∏–º–µ–Ω–∏:', chat);
                        return false;
                    }
                    return chat.name.toLowerCase().includes(searchTerm);
                });
                console.log(`üìã –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —á–∞—Ç–æ–≤: ${filteredChats.length}`);
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–≤–µ—Ä—Ö—É
                const sortedChats = [
                    ...filteredChats.filter(c => c.selected),
                    ...filteredChats.filter(c => !c.selected)
                ];
                console.log(`üìä –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —á–∞—Ç–æ–≤: ${sortedChats.length} (–≤—ã–±—Ä–∞–Ω–æ: ${filteredChats.filter(c => c.selected).length})`);
                
                const container = document.getElementById('chatsList');
                if (!container) {
                    console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç chatsList –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    return;
                }
                
                if (sortedChats.length === 0) {
                    console.warn('‚ÑπÔ∏è –ù–µ—Ç —á–∞—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    if (allChats.length === 0) {
                        container.innerHTML = '<div class="text-center text-muted p-3">–ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ WhatsApp –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –≥–æ—Ç–æ–≤.</div>';
                    } else {
                        container.innerHTML = '<div class="text-center text-muted p-3">–ß–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É "' + escapeHtml(searchTerm) + '"</div>';
                    }
                    return;
                }
                
                console.log('üìã –®–ê–ì 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –¥–ª—è —á–∞—Ç–æ–≤...');
                console.log(`üìä –í—Å–µ–≥–æ —á–∞—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${sortedChats.length}`);
                console.log(`üìä –ü–µ—Ä–≤—ã–µ 3 —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:`, sortedChats.slice(0, 3));
                
                const htmlStartTime = performance.now();
                const htmlContent = sortedChats.map((chat, index) => {
                    if (index < 3) {
                        console.log(`   –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –¥–ª—è —á–∞—Ç–∞ ${index + 1}:`, {
                            id: chat.id,
                            name: chat.name,
                            type: chat.type,
                            selected: chat.selected
                        });
                    }
                    try {
                        const chatTypeBadge = chat.type === 'group' 
                            ? '<span class="badge bg-primary me-2">–ì—Ä—É–ø–ø–∞</span>' 
                            : '<span class="badge bg-secondary me-2">–õ–∏—á–Ω—ã–π</span>';
                        
                        // –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π ID –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–∞ id
                        const safeIdForAttr = String(chat.id).replace(/[^a-zA-Z0-9]/g, '_');
                        
                        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º ID –¥–ª—è data-–∞—Ç—Ä–∏–±—É—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º HTML-—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
                        const escapedChatId = escapeHtml(String(chat.id));
                        
                        return `
                        <div class="chat-item d-flex align-items-center p-2 border-bottom" style="cursor: pointer;">
                            <div class="form-check me-3">
                                <input class="form-check-input chat-checkbox" type="checkbox" 
                                       ${chat.selected ? 'checked' : ''} 
                                       data-chat-id="${escapedChatId}"
                                       id="chat-${safeIdForAttr}">
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">${chatTypeBadge}${escapeHtml(chat.name)}</div>
                                <small class="text-muted">${escapeHtml(chat.id)}</small>
                                ${chat.unreadCount > 0 ? `<span class="badge bg-danger ms-2">${chat.unreadCount} –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö</span>` : ''}
                            </div>
                            ${chat.selected ? '<span class="badge bg-success">–í—ã–±—Ä–∞–Ω–æ</span>' : ''}
                        </div>
                    `;
                    } catch (chatError) {
                        console.error(`‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML –¥–ª—è —á–∞—Ç–∞ ${index}:`, chatError);
                        return '';
                    }
                }).join('');
                
                const htmlDuration = performance.now() - htmlStartTime;
                console.log(`‚úÖ HTML —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞ ${htmlDuration.toFixed(2)}–º—Å`);
                console.log(`üìù –†–∞–∑–º–µ—Ä HTML: ${htmlContent.length} —Å–∏–º–≤–æ–ª–æ–≤`);
                console.log(`üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ chat-item: ${(htmlContent.match(/chat-item/g) || []).length}`);
                
                console.log('üìã –®–ê–ì 2: –í—Å—Ç–∞–≤–∫–∞ HTML –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...');
                const insertStartTime = performance.now();
                container.innerHTML = htmlContent;
                const insertDuration = performance.now() - insertStartTime;
                console.log(`‚úÖ HTML –≤—Å—Ç–∞–≤–ª–µ–Ω –∑–∞ ${insertDuration.toFixed(2)}–º—Å`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
                console.log('üìã –®–ê–ì 2.1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤...');
                const checkboxStartTime = performance.now();
                const checkboxes = container.querySelectorAll('.chat-checkbox');
                console.log(`üìä –ù–∞–π–¥–µ–Ω–æ —á–µ–∫–±–æ–∫—Å–æ–≤: ${checkboxes.length}`);
                checkboxes.forEach(checkbox => {
                    const chatId = checkbox.getAttribute('data-chat-id');
                    if (chatId) {
                        checkbox.addEventListener('change', function() {
                            toggleChatSelection(chatId, this.checked);
                        });
                    }
                });
                const checkboxDuration = performance.now() - checkboxStartTime;
                console.log(`‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞ ${checkboxDuration.toFixed(2)}–º—Å`);
                
                console.log('üìã –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...');
                console.log(`üìä –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä chatsList –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏:`, {
                    innerHTMLLength: container.innerHTML.length,
                    childrenCount: container.children.length,
                    firstChild: container.firstElementChild ? {
                        tagName: container.firstElementChild.tagName,
                        className: container.firstElementChild.className,
                        id: container.firstElementChild.id,
                        innerText: container.firstElementChild.innerText?.substring(0, 50)
                    } : '–Ω–µ—Ç',
                    allChildren: Array.from(container.children).slice(0, 3).map(el => ({
                        tagName: el.tagName,
                        className: el.className
                    }))
                });
                
                const totalDisplayDuration = performance.now() - displayStartTime;
                console.log('‚ïê'.repeat(80));
                console.log('‚úÖ –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ß–ê–¢–û–í –ó–ê–í–ï–†–®–ï–ù–û');
                console.log('‚ïê'.repeat(80));
                console.log(`‚è±Ô∏è –û–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${totalDisplayDuration.toFixed(2)}–º—Å`);
                console.log(`   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML: ${htmlDuration.toFixed(2)}–º—Å`);
                console.log(`   - –í—Å—Ç–∞–≤–∫–∞ HTML: ${insertDuration.toFixed(2)}–º—Å`);
                console.log(`üìä –û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ —á–∞—Ç–æ–≤: ${sortedChats.length}`);
                console.log('‚ïê'.repeat(80));
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤ displayChats():', error);
                console.error('Stack trace:', error.stack);
                const container = document.getElementById('chatsList');
                if (container) {
                    container.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–∞—Ç–æ–≤: ${escapeHtml(error.message)}</div>`;
                }
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞
        function toggleChatSelection(chatId, selected) {
            try {
                // chatId —É–∂–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
                const actualChatId = String(chatId);
                
                console.log(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞:`, {
                    chatId: actualChatId,
                    type: typeof actualChatId,
                    selected: selected,
                    currentSize: selectedChatIds.size
                });
                
                if (selected) {
                    selectedChatIds.add(actualChatId);
                } else {
                    selectedChatIds.delete(actualChatId);
                }
                
                console.log(`üìä –†–∞–∑–º–µ—Ä selectedChatIds –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: ${selectedChatIds.size}`);
                console.log(`üìã –í—ã–±—Ä–∞–Ω–Ω—ã–µ ID:`, Array.from(selectedChatIds));
                
                // –ò—â–µ–º —á–∞—Ç –ø–æ ID (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏)
                const chat = allChats.find(c => String(c.id) === String(actualChatId));
                if (chat) {
                    chat.selected = selected;
                    console.log(`‚úÖ –ß–∞—Ç "${chat.name}" (${chat.type}) ${selected ? '–≤—ã–±—Ä–∞–Ω' : '—Å–Ω—è—Ç —Å –≤—ã–±–æ—Ä–∞'}`);
                } else {
                    console.warn(`‚ö†Ô∏è –ß–∞—Ç —Å ID ${actualChatId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ allChats`);
                    console.warn(`üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ ID (–ø–µ—Ä–≤—ã–µ 5):`, allChats.slice(0, 5).map(c => ({ id: c.id, type: typeof c.id })));
                }
                
                displayChats();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤ toggleChatSelection():', error);
                console.error('Stack trace:', error.stack);
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–∞—Ç–æ–≤
        function filterChats() {
            displayChats();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
        async function loadPrompts() {
            try {
                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤...');
                const response = await fetch('/api/prompts');
                
                if (!response.ok) {
                    console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤: HTTP ${response.status}`);
                    availablePrompts = [];
                    return;
                }
                
                const data = await response.json();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤
                if (Array.isArray(data)) {
                    availablePrompts = data;
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–º–ø—Ç–æ–≤: ${availablePrompts.length}`);
                } else if (data.error) {
                    console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–ø—Ç–æ–≤: ${data.error}`);
                    availablePrompts = [];
                } else {
                    availablePrompts = [];
                    console.warn('‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç /api/prompts');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤:', error);
                availablePrompts = [];
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π
        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks');
                const data = await response.json();
                tasks = data.tasks || [];
                displayTasks();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:', error);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π
        function displayTasks() {
            const container = document.getElementById('tasksList');
            if (tasks.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">–ó–∞–¥–∞–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                return;
            }
            
            container.innerHTML = tasks.map(task => {
                const prompt = availablePrompts.find(p => p.id === task.promptId);
                const promptName = prompt ? prompt.name : `ID: ${task.promptId}`;
                const chatCount = task.chatIds ? task.chatIds.length : 0;
                
                return `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${escapeHtml(task.name)}</h6>
                                    <small class="text-muted">
                                        –ü—Ä–æ–º–ø—Ç: ${escapeHtml(promptName)} | 
                                        –ì—Ä—É–ø–ø: ${chatCount} | 
                                        ${task.active ? '<span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–æ</span>' : '<span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–Ω–æ</span>'}
                                    </small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})">
                                        <i class="fe fe-trash-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è
        function showAddTaskModal() {
            console.log('üìã showAddTaskModal –≤—ã–∑–≤–∞–Ω–∞');
            console.log('üìä selectedChatIds.size:', selectedChatIds.size);
            console.log('üìã –í—ã–±—Ä–∞–Ω–Ω—ã–µ ID:', Array.from(selectedChatIds));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω—ã –∏–º–µ–Ω–Ω–æ –≥—Ä—É–ø–ø—ã
            const selectedGroups = allChats.filter(chat => 
                selectedChatIds.has(chat.id) && chat.type === 'group'
            );
            
            console.log('üìä –í—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã:', selectedGroups.length);
            console.log('üìã –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø:', selectedGroups.map(g => ({ id: g.id, name: g.name })));
            
            if (selectedChatIds.size === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥—Ä—É–ø–ø—É');
                return;
            }
            
            if (selectedGroups.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥—Ä—É–ø–ø—É (–Ω–µ –ª–∏—á–Ω—ã–π —á–∞—Ç)');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
                                <input type="text" class="form-control" id="taskNameInput" 
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–¥–∞–∂">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</label>
                                <select class="form-select" id="taskPromptSelect">
                                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–í—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã (${selectedChatIds.size})</label>
                                <div class="small text-muted">
                                    ${Array.from(selectedChatIds).map(id => {
                                        const chat = allChats.find(c => c.id === id);
                                        return chat ? escapeHtml(chat.name) : id;
                                    }).join(', ')}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                            <button type="button" class="btn btn-primary" onclick="createTask()">–°–æ–∑–¥–∞—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç—ã
            const select = modal.querySelector('#taskPromptSelect');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–º–ø—Ç --</option>';
            availablePrompts.forEach(prompt => {
                const option = document.createElement('option');
                option.value = prompt.id;
                option.textContent = `${prompt.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'} (ID: ${prompt.id})`;
                select.appendChild(option);
            });
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
            
            window.createTask = async function() {
                console.log('üìã createTask –≤—ã–∑–≤–∞–Ω–∞');
                console.log('üìä selectedChatIds.size:', selectedChatIds.size);
                console.log('üìã –í—ã–±—Ä–∞–Ω–Ω—ã–µ ID:', Array.from(selectedChatIds));
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≥—Ä—É–ø–ø—ã
                const selectedGroups = allChats.filter(chat => 
                    selectedChatIds.has(chat.id) && chat.type === 'group'
                );
                
                console.log('üìä –í—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∑–∞–¥–∞–Ω–∏—è:', selectedGroups.length);
                console.log('üìã ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø:', selectedGroups.map(g => g.id));
                
                if (selectedGroups.length === 0) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥—Ä—É–ø–ø—É (–Ω–µ –ª–∏—á–Ω—ã–π —á–∞—Ç)');
                    return;
                }
                
                const name = document.getElementById('taskNameInput').value.trim() || `–ó–∞–¥–∞–Ω–∏–µ ${Date.now()}`;
                const promptId = parseInt(document.getElementById('taskPromptSelect').value);
                
                if (!promptId) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–º–ø—Ç');
                    return;
                }
                
                const groupIds = selectedGroups.map(g => g.id);
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:', {
                    name,
                    promptId,
                    chatIds: groupIds,
                    chatIdsCount: groupIds.length
                });
                
                try {
                    const response = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            promptId,
                            chatIds: groupIds
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        bsModal.hide();
                        loadTasks();
                        selectedChatIds.clear();
                        refreshChats();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
                }
            };
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function showTestMessageModal() {
            console.log('üìã showTestMessageModal –≤—ã–∑–≤–∞–Ω–∞');
            console.log('üìä selectedChatIds.size:', selectedChatIds.size);
            console.log('üìã –í—ã–±—Ä–∞–Ω–Ω—ã–µ ID:', Array.from(selectedChatIds));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–∞ –æ–¥–Ω–∞ –≥—Ä—É–ø–ø–∞
            const selectedGroups = allChats.filter(chat => 
                selectedChatIds.has(chat.id) && chat.type === 'group'
            );
            
            console.log('üìä –í—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã:', selectedGroups.length);
            console.log('üìã –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø:', selectedGroups.map(g => ({ id: g.id, name: g.name })));
            
            if (selectedGroups.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            if (selectedGroups.length > 1) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            const selectedGroup = selectedGroups[0];
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">–ì—Ä—É–ø–ø–∞</label>
                                <input type="text" class="form-control" id="testMessageChatName" 
                                       value="${escapeHtml(selectedGroup.name)}" readonly>
                                <input type="hidden" id="testMessageChatId" value="${escapeHtml(selectedGroup.id)}">
                                <small class="text-muted">ID: ${escapeHtml(selectedGroup.id)}</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                                <textarea class="form-control" id="testMessageContent" rows="5" 
                                          placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <input type="text" class="form-control" id="testMessageSenderName" 
                                       placeholder="–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è" value="Test User">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <input type="text" class="form-control" id="testMessageSenderPhone" 
                                       placeholder="+79999999999" value="+79999999999">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–ü—Ä–æ–º–ø—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <select class="form-select" id="testMessagePromptSelect">
                                    <option value="">-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –∏–∑ –∑–∞–¥–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å) --</option>
                                </select>
                                <small class="text-muted">–ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–æ–º–ø—Ç –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                            <button type="button" class="btn btn-primary" onclick="sendTestMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç—ã
            const select = modal.querySelector('#testMessagePromptSelect');
            availablePrompts.forEach(prompt => {
                const option = document.createElement('option');
                option.value = prompt.id;
                option.textContent = `${prompt.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'} (ID: ${prompt.id})`;
                select.appendChild(option);
            });
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
            
            window.sendTestMessage = async function() {
                const chatId = document.getElementById('testMessageChatId').value;
                const chatName = document.getElementById('testMessageChatName').value;
                const content = document.getElementById('testMessageContent').value.trim();
                const senderName = document.getElementById('testMessageSenderName').value.trim() || 'Test User';
                const senderPhone = document.getElementById('testMessageSenderPhone').value.trim() || '+79999999999';
                const promptId = document.getElementById('testMessagePromptSelect').value ? 
                    parseInt(document.getElementById('testMessagePromptSelect').value) : null;
                
                if (!content) {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                    return;
                }
                
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', {
                    chatId,
                    chatName,
                    content: content.substring(0, 50) + '...',
                    senderName,
                    senderPhone,
                    promptId
                });
                
                const sendButton = modal.querySelector('button[onclick="sendTestMessage()"]');
                const originalText = sendButton.innerHTML;
                sendButton.disabled = true;
                sendButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>–û—Ç–ø—Ä–∞–≤–∫–∞...';
                
                try {
                    const response = await fetch('/api/test-message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chatId: chatId,
                            chatName: chatName,
                            content: content,
                            senderName: senderName,
                            senderPhone: senderPhone,
                            isGroup: true,
                            promptId: promptId
                        })
                    });
                    
                    const data = await response.json();
                    if (response.ok && data.success) {
                        bsModal.hide();
                        alert('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.');
                    } else {
                        alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
                } finally {
                    sendButton.disabled = false;
                    sendButton.innerHTML = originalText;
                }
            };
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
        async function deleteTask(taskId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ?')) return;
            
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.success) {
                    loadTasks();
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã chats.html...');
            
            // –°—Ç–∞—Ç—É—Å WhatsApp –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ whatsapp-status.js
            // –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º refreshWhatsAppStatus –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
            if (typeof window.refreshWhatsAppStatus === 'function') {
                await window.refreshWhatsAppStatus();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã –∏ –∑–∞–¥–∞–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –∑–∞–≥—Ä—É–∑–∫—É —á–∞—Ç–æ–≤
            Promise.all([
                loadPrompts().catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤:', err)),
                loadTasks().catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:', err))
            ]).then(() => {
                console.log('‚úÖ –ü—Ä–æ–º–ø—Ç—ã –∏ –∑–∞–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã —Å—Ä–∞–∑—É, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –ø—Ä–æ–º–ø—Ç–æ–≤
            await refreshChats();
            
            console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã chats.html –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        });
    </script>
    <style>
        /* –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .card.custom-card {
            width: 100%;
            min-width: 100%;
        }
        .card-body {
            width: 100% !important;
            min-width: 100% !important;
        }
        #chatsList {
            width: 100% !important;
            min-width: 100% !important;
        }
        .chat-item {
            width: 100% !important;
            min-width: 100% !important;
            padding: 12px !important;
        }
        .chat-item .flex-grow-1 {
            min-width: 0;
            flex: 1 1 auto;
            width: 100%;
        }
        #tasksList {
            width: 100% !important;
            min-width: 100% !important;
        }
        .task-item {
            width: 100% !important;
            min-width: 100% !important;
            padding: 12px !important;
        }
        .row {
            width: 100%;
            margin-left: 0;
            margin-right: 0;
        }
        .col-xl-12 {
            width: 100%;
            padding-left: 15px;
            padding-right: 15px;
        }
        
        .chat-item:hover {
            background-color: #f8f9fa;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>

</html>
