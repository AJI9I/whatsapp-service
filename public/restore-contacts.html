<!DOCTYPE html>
<html lang="ru" dir="ltr" data-nav-layout="vertical" data-theme-mode="light" data-header-styles="light" data-menu-styles="light" data-toggled="open">

<head>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ - WhatsApp Service</title>
    <meta name="Description" content="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö –∏–∑ WhatsApp API">
    
    <link rel="icon" href="/bootstrap-theme/assets/images/brand-logos/favicon.ico" type="image/x-icon">
    <link id="style" href="/bootstrap-theme/assets/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/bootstrap-theme/assets/css/styles.min.css" rel="stylesheet">
    <link href="/bootstrap-theme/assets/css/icons.css" rel="stylesheet">
    <link href="/bootstrap-theme/assets/libs/node-waves/waves.min.css" rel="stylesheet">
    <link href="/bootstrap-theme/assets/libs/simplebar/simplebar.min.css" rel="stylesheet">
    
    <!-- –û–±—â–µ–µ –º–µ–Ω—é -->
    <script src="/menu.js"></script>
    
    <style>
        .app-sidebar {
            display: block !important;
            visibility: visible !important;
        }
        .main-menu {
            display: block !important;
        }
        .side-menu__item {
            display: flex !important;
            align-items: center !important;
            padding: 0.75rem 1.25rem !important;
            color: #495057 !important;
            text-decoration: none !important;
        }
        .side-menu__item:hover {
            background-color: #f8f9fa !important;
        }
        .side-menu__item.active {
            background-color: #e7f1ff !important;
            color: #0d6efd !important;
        }
        .side-menu__icon {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            fill: currentColor;
        }
        .side-menu__label {
            display: block !important;
        }
        .restore-logs-container {
            height: 500px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-entry {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        .log-level-info { color: #4ec9b0; }
        .log-level-warn { color: #dcdcaa; }
        .log-level-error { color: #f48771; }
        .log-level-debug { color: #569cd6; }
        .log-timestamp {
            color: #858585;
            margin-right: 8px;
        }
    </style>
</head>

<body>
    <div class="page">
        <header class="app-header">
            <div class="main-header-container container-fluid">
                <div class="header-content-left">
                    <div class="header-element">
                        <a aria-label="Toggle Sidebar" class="sidemenu-toggle header-link animated-arrow hor-toggle horizontal-navtoggle" data-bs-toggle="sidebar" href="javascript:void(0);">
                            <i class="header-icon fe fe-align-left"></i>
                        </a>
                    </div>
                    <div class="header-element">
                        <div class="horizontal-logo">
                            <a href="/" class="header-logo">
                                <span class="desktop-logo">üì± WhatsApp Service</span>
                                <span class="toggle-logo">WhatsApp</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="header-content-right">
                    <div class="header-element">
                        <span class="badge bg-success" id="serviceStatusBadge">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                    </div>
                </div>
            </div>
        </header>

        <aside class="app-sidebar sticky" id="sidebar">
            <div class="main-sidebar-header">
                <a href="/" class="header-logo">
                    <span class="desktop-logo">üì± WhatsApp</span>
                    <span class="toggle-logo">WA</span>
                </a>
            </div>
            <div class="main-sidebar" id="sidebar-scroll">
                <nav class="main-menu-container nav nav-pills flex-column sub-open">
                    <ul class="main-menu" id="main-menu">
                        <!-- –ú–µ–Ω—é –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ menu.js -->
                    </ul>
                </nav>
            </div>
        </aside>

        <div class="main-content app-content">
            <div class="container-fluid">
                <div class="d-md-flex d-block align-items-center justify-content-between my-4 page-header-breadcrumb">
                    <div class="my-auto">
                        <h5 class="page-title fs-21 mb-1">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</h5>
                        <nav>
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                                <li class="breadcrumb-item active" aria-current="page">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</li>
                            </ol>
                        </nav>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xl-12">
                        <div class="card custom-card">
                            <div class="card-header justify-content-between">
                                <div class="card-title">
                                    <i class="fe fe-refresh-cw me-2"></i>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearLogs()">
                                        <i class="fe fe-trash-2 me-1"></i> –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                                        <i class="fe fe-refresh-cw me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs mb-3" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="offers-tab" data-bs-toggle="tab" data-bs-target="#offers-pane" type="button" role="tab">
                                            <i class="fe fe-list me-1"></i> –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="mass-restore-tab" data-bs-toggle="tab" data-bs-target="#mass-restore-pane" type="button" role="tab">
                                            <i class="fe fe-play me-1"></i> –ú–∞—Å—Å–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-pane" type="button" role="tab">
                                            <i class="fe fe-file-text me-1"></i> –õ–æ–≥–∏
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content">
                                    <!-- –í–∫–ª–∞–¥–∫–∞: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è -->
                                    <div class="tab-pane fade show active" id="offers-pane" role="tabpanel">
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div>
                                                    <button class="btn btn-sm btn-primary me-2" onclick="loadOffers()">
                                                        <i class="fe fe-refresh-cw me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                                                    </button>
                                                    <button class="btn btn-sm btn-success" onclick="restoreSelected()" id="restoreSelectedBtn" disabled>
                                                        <i class="fe fe-check me-1"></i> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="selectAll()">
                                                        <i class="fe fe-check-square me-1"></i> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                                                        <i class="fe fe-square me-1"></i> –°–Ω—è—Ç—å –≤—ã–±–æ—Ä
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info ms-2" onclick="showFindContactModal()" title="–ù–∞–π—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç –≤ –≥—Ä—É–ø–ø–∞—Ö">
                                                        <i class="fe fe-search me-1"></i> –ù–∞–π—Ç–∏ –≤ –≥—Ä—É–ø–ø–∞—Ö
                                                    </button>
                                                </div>
                                                <div>
                                                    <span class="badge bg-info" id="offersCount">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                            <table class="table table-hover">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th width="40">
                                                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                                        </th>
                                                        <th>ID</th>
                                                        <th>–ü—Ä–æ–¥–∞–≤–µ—Ü (—Ç–µ–∫—É—â–µ–µ)</th>
                                                        <th>–¢–µ–ª–µ—Ñ–æ–Ω (—Ç–µ–∫—É—â–∏–π)</th>
                                                        <th>–¢–∏–ø</th>
                                                        <th>–¶–µ–Ω–∞</th>
                                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                                        <th>–ß–∞—Ç</th>
                                                        <th>–î–∞—Ç–∞</th>
                                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                                </tr>
                                            </thead>
                                            <tbody id="offersTableBody">
                                                <tr>
                                                    <td colspan="10" class="text-center text-muted py-4">
                                                        <span class="spinner-border spinner-border-sm me-2"></span>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö -->
                                    <div class="modal fade" id="findContactModal" tabindex="-1" aria-labelledby="findContactModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="findContactModalLabel">
                                                        <i class="fe fe-search me-2"></i>–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="searchContactId" class="form-label">WhatsApp ID –¥–ª—è –ø–æ–∏—Å–∫–∞</label>
                                                        <input type="text" class="form-control" id="searchContactId" 
                                                               placeholder="120363046456598557 –∏–ª–∏ 120363046456598557@c.us">
                                                        <small class="text-muted">–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–Ω—Ç–∞–∫—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö –≤—Å–µ—Ö –≥—Ä—É–ø–ø</small>
                                                    </div>
                                                    <button class="btn btn-primary" onclick="findContactInGroups()">
                                                        <i class="fe fe-search me-1"></i> –ù–∞–π—Ç–∏
                                                    </button>
                                                    
                                                    <div id="findContactResults" class="mt-4" style="display: none;">
                                                        <h6>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</h6>
                                                        <div id="findContactResultsContent"></div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                    <!-- –í–∫–ª–∞–¥–∫–∞: –ú–∞—Å—Å–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ -->
                                    <div class="tab-pane fade" id="mass-restore-pane" role="tabpanel">
                                        <div class="mb-4">
                                            <p class="text-muted mb-3">
                                                –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–æ–º–µ—Ä–∞—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –∏ –∏–º–µ–Ω–∞—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π –∏–∑ WhatsApp API.
                                                –£—Ç–∏–ª–∏—Ç–∞ –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–ø–∏—Å–∏ —Å WhatsApp ID –≤–º–µ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏—Ö.
                                            </p>
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label">–¢–∏–ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</label>
                                                    <select class="form-select" id="restoreType">
                                                        <option value="all">–í—Å–µ (–ø—Ä–æ–¥–∞–≤—Ü—ã + –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)</option>
                                                        <option value="sellers">–¢–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞–≤—Ü—ã</option>
                                                        <option value="offers">–¢–æ–ª—å–∫–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-8 mb-3 d-flex align-items-end">
                                                    <button class="btn btn-primary" onclick="startRestore()" id="restoreBtn">
                                                        <i class="fe fe-play me-1"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- –í–∫–ª–∞–¥–∫–∞: –õ–æ–≥–∏ -->
                                    <div class="tab-pane fade" id="logs-pane" role="tabpanel">
                                        <div class="restore-logs-container" id="restoreLogsContainer">
                                            <div class="text-muted">–õ–æ–≥–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer mt-auto py-4 bg-white">
            <div class="container-fluid">
                <div class="text-center">
                    <span class="text-muted">WhatsApp Service &copy; 2025</span>
                </div>
            </div>
        </footer>
    </div>

    <script src="/bootstrap-theme/assets/libs/@popperjs/core/umd/popper.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/node-waves/waves.min.js"></script>
    <script src="/bootstrap-theme/assets/libs/simplebar/simplebar.min.js"></script>
    
    <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ WhatsApp -->
    <script src="/whatsapp-status.js"></script>
    
    <script>
        let logRefreshInterval = null;
        let isRestoring = false;
        let offersList = [];
        let selectedOffers = new Set();

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadOffers();
            refreshLogs();
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            const logsContainer = document.getElementById('restoreLogsContainer');
            if (logsContainer) {
                logsContainer.addEventListener('scroll', function() {
                    isUserScrollingLogs = true;
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
                    if (logsScrollTimeout) {
                        clearTimeout(logsScrollTimeout);
                    }
                    
                    // –ß–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫–æ–Ω—á–∏–ª
                    logsScrollTimeout = setTimeout(function() {
                        isUserScrollingLogs = false;
                    }, 1000);
                });
            }
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            logRefreshInterval = setInterval(refreshLogs, 2000);
        });

        // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (logRefreshInterval) {
                clearInterval(logRefreshInterval);
            }
        });

        async function refreshLogs() {
            try {
                const response = await fetch('/api/restore-contacts/logs');
                const data = await response.json();
                displayLogs(data.logs || []);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤:', error);
            }
        }

        let isUserScrollingLogs = false;
        let logsScrollTimeout = null;

        function displayLogs(logs) {
            const container = document.getElementById('restoreLogsContainer');
            if (!container) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            const currentScrollTop = container.scrollTop;
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;
            const isScrolledToBottom = (scrollHeight - clientHeight - currentScrollTop) < 10; // –î–æ–ø—É—Å–∫ 10px

            if (logs.length === 0) {
                container.innerHTML = '<div class="text-muted">–õ–æ–≥–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>';
                return;
            }

            let html = '';
            logs.forEach(log => {
                const timestamp = new Date(log.timestamp).toLocaleTimeString('ru-RU');
                const levelClass = `log-level-${log.level}`;
                html += `<div class="log-entry">
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="${levelClass}">[${log.level.toUpperCase()}]</span>
                    <span class="log-message">${escapeHtml(log.message)}</span>
                </div>`;
            });

            container.innerHTML = html;

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤–Ω–∏–∑—É –∏ –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç
            if (!isUserScrollingLogs && isScrolledToBottom) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤–Ω–∏–∑—É - –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤—ã–º –ª–æ–≥–∞–º
                container.scrollTop = container.scrollHeight;
            } else if (!isUserScrollingLogs) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–ª, –Ω–æ –±—ã–ª –Ω–µ –≤–Ω–∏–∑—É - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
                container.scrollTop = currentScrollTop;
            }
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫—Ä–æ–ª–ª–∏—Ç - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function startRestore() {
            if (isRestoring) {
                alert('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.');
                return;
            }

            const type = document.getElementById('restoreType').value;
            const btn = document.getElementById('restoreBtn');
            
            isRestoring = true;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> –ó–∞–ø—É—Å–∫...';

            try {
                const response = await fetch('/api/restore-contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type })
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ! –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –Ω–∏–∂–µ.');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message);
            } finally {
                isRestoring = false;
                btn.disabled = false;
                btn.innerHTML = '<i class="fe fe-play me-1"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ';
            }
        }

        async function clearLogs() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è?')) {
                return;
            }

            try {
                const response = await fetch('/api/restore-contacts/logs/clear', {
                    method: 'POST'
                });

                if (response.ok) {
                    refreshLogs();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤: ' + error.message);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
        async function loadOffers() {
            const tbody = document.getElementById('offersTableBody');
            const countBadge = document.getElementById('offersCount');
            
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4"><span class="spinner-border spinner-border-sm me-2"></span>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...</td></tr>';
            
            try {
                const response = await fetch('/api/restore-contacts/offers?limit=1000');
                const data = await response.json();
                
                offersList = data.offers || [];
                countBadge.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${offersList.length}`;
                
                if (offersList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</td></tr>';
                    return;
                }
                
                displayOffers(offersList);
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</td></tr>`;
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:', error);
            }
        }

        function displayOffers(offers) {
            const tbody = document.getElementById('offersTableBody');
            selectedOffers.clear();
            updateRestoreButton();
            
            if (offers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</td></tr>';
                return;
            }
            
            let html = '';
            offers.forEach(offer => {
                const whatsappId = isWhatsAppId(offer.seller_name) ? offer.seller_name : 
                                  (isWhatsAppId(offer.seller_phone) ? offer.seller_phone : '');
                const date = new Date(offer.created_at).toLocaleString('ru-RU');
                
                html += `<tr id="offer-row-${offer.id}">
                    <td>
                        <input type="checkbox" class="offer-checkbox" value="${offer.id}" onchange="toggleOffer(${offer.id})">
                    </td>
                    <td>${offer.id}</td>
                    <td><code>${escapeHtml(offer.seller_name || '')}</code></td>
                    <td><code>${escapeHtml(offer.seller_phone || '')}</code></td>
                    <td><span class="badge ${offer.operation_type === 'SELL' ? 'bg-success' : 'bg-info'}">${offer.operation_type || ''}</span></td>
                    <td>${offer.price ? offer.price.toLocaleString('ru-RU') : '-'}</td>
                    <td>${offer.quantity || '-'}</td>
                    <td><small>${escapeHtml(offer.source_chat_name || '')}</small></td>
                    <td><small>${date}</small></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="restoreSingle(${offer.id})" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ">
                            <i class="fe fe-refresh-cw"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }

        function isWhatsAppId(str) {
            if (!str || typeof str !== 'string') return false;
            const cleaned = str.trim();
            return (cleaned.length > 12 && /^\d+$/.test(cleaned)) || 
                   (cleaned.includes('@') && cleaned.length > 15);
        }

        function toggleOffer(offerId) {
            const checkbox = document.querySelector(`.offer-checkbox[value="${offerId}"]`);
            if (checkbox.checked) {
                selectedOffers.add(offerId);
            } else {
                selectedOffers.delete(offerId);
            }
            updateRestoreButton();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.offer-checkbox').forEach(cb => {
                cb.checked = selectAll;
                const offerId = parseInt(cb.value);
                if (selectAll) {
                    selectedOffers.add(offerId);
                } else {
                    selectedOffers.delete(offerId);
                }
            });
            updateRestoreButton();
        }

        function selectAll() {
            document.getElementById('selectAllCheckbox').checked = true;
            toggleSelectAll();
        }

        function deselectAll() {
            document.getElementById('selectAllCheckbox').checked = false;
            toggleSelectAll();
        }

        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('.offer-checkbox');
            const checked = document.querySelectorAll('.offer-checkbox:checked');
            document.getElementById('selectAllCheckbox').checked = checkboxes.length > 0 && checked.length === checkboxes.length;
        }

        function updateRestoreButton() {
            const btn = document.getElementById('restoreSelectedBtn');
            btn.disabled = selectedOffers.size === 0;
            btn.textContent = selectedOffers.size > 0 ? 
                `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${selectedOffers.size})` : 
                '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
        }

        async function restoreSelected() {
            if (selectedOffers.size === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                return;
            }

            if (!confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ${selectedOffers.size} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π?`)) {
                return;
            }

            const offerIds = Array.from(selectedOffers);
            let success = 0;
            let failed = 0;

            for (const offerId of offerIds) {
                try {
                    await restoreSingle(offerId, false);
                    success++;
                } catch (error) {
                    failed++;
                    console.error(`–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ${offerId}:`, error);
                }
            }

            alert(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n–£—Å–ø–µ—à–Ω–æ: ${success}\n–û—à–∏–±–æ–∫: ${failed}`);
            selectedOffers.clear();
            await loadOffers();
        }

        async function restoreSingle(offerId, showAlert = true) {
            const row = document.getElementById(`offer-row-${offerId}`);
            if (row) {
                const btn = row.querySelector('button');
                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                
                try {
                    const response = await fetch(`/api/restore-contacts/offers/${offerId}`, {
                        method: 'POST'
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        if (showAlert) {
                            const message = data.result.partial 
                                ? `–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ID=${offerId} —á–∞—Å—Ç–∏—á–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!\n–¢–µ–ª–µ—Ñ–æ–Ω: "${data.result.oldPhone}" ‚Üí "${data.result.newPhone}"\n–ò–º—è: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`
                                : `–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ID=${offerId} —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!\n"${data.result.oldName}" ‚Üí "${data.result.newName}"\n"${data.result.oldPhone}" ‚Üí "${data.result.newPhone}"`;
                            alert(message);
                        }
                        btn.innerHTML = '<i class="fe fe-check text-success"></i>';
                        setTimeout(() => {
                            loadOffers();
                        }, 1000);
                    } else {
                        throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    }
                } catch (error) {
                    btn.innerHTML = '<i class="fe fe-x text-danger"></i>';
                    if (showAlert) {
                        alert(`–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ID=${offerId}: ${error.message}`);
                    }
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                    }, 2000);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö
        function showFindContactModal() {
            const modal = new bootstrap.Modal(document.getElementById('findContactModal'));
            modal.show();
        }

        function findContactById(contactId) {
            document.getElementById('searchContactId').value = contactId;
            showFindContactModal();
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫
            setTimeout(() => findContactInGroups(), 500);
        }

        async function findContactInGroups() {
            const contactId = document.getElementById('searchContactId').value.trim();
            if (!contactId) {
                alert('–í–≤–µ–¥–∏—Ç–µ WhatsApp ID –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }

            const resultsDiv = document.getElementById('findContactResults');
            const resultsContent = document.getElementById('findContactResultsContent');
            
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm me-2"></span>–ü–æ–∏—Å–∫...</div>';

            try {
                const response = await fetch(`/api/find-contact/${encodeURIComponent(contactId)}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
                }

                let html = '';
                
                if (data.found) {
                    html += `<div class="alert alert-success">
                        <strong>‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç –Ω–∞–π–¥–µ–Ω!</strong> –ù–∞–π–¥–µ–Ω –≤ ${data.foundIn.length} –≥—Ä—É–ø–ø–µ(–∞—Ö)
                    </div>`;
                    
                    data.foundIn.forEach((item, index) => {
                        html += `<div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-title">–ì—Ä—É–ø–ø–∞ ${index + 1}: ${escapeHtml(item.chatName)}</h6>
                                <p class="mb-1"><strong>ID –∫–æ–Ω—Ç–∞–∫—Ç–∞:</strong> <code>${escapeHtml(item.contact.id)}</code></p>
                                <p class="mb-1"><strong>User ID:</strong> <code>${escapeHtml(item.contact.userId)}</code></p>
                                <p class="mb-1"><strong>–ù–æ–º–µ—Ä:</strong> <code>${escapeHtml(item.contact.number)}</code></p>
                                <p class="mb-1"><strong>–ò–º—è:</strong> ${escapeHtml(item.contact.name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}</p>
                                <p class="mb-0"><strong>Pushname:</strong> ${escapeHtml(item.contact.pushname || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}</p>
                            </div>
                        </div>`;
                    });
                } else {
                    html += `<div class="alert alert-warning">
                        <strong>‚ö†Ô∏è –ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</strong> –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö –≥—Ä—É–ø–ø
                    </div>`;
                    html += `<p>–ò—Å–∫–∞–ª–∏: <code>${escapeHtml(contactId)}</code></p>`;
                    html += `<p>User ID: <code>${escapeHtml(data.userId)}</code></p>`;
                    html += `<p>Formatted ID: <code>${escapeHtml(data.formattedId)}</code></p>`;
                }

                html += `<div class="mt-3">
                    <h6>–í—Å–µ–≥–æ –≥—Ä—É–ø–ø –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ: ${data.totalGroups}</h6>
                    <details>
                        <summary>–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≥—Ä—É–ø–ø</summary>
                        <ul class="mt-2">`;
                
                data.allGroups.forEach(group => {
                    html += `<li>${escapeHtml(group.chatName)} (${group.participantCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)</li>`;
                });
                
                html += `</ul></details></div>`;

                resultsContent.innerHTML = html;

            } catch (error) {
                resultsContent.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>

