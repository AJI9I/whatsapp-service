# Утилита восстановления контактов

Утилита для восстановления достоверной информации о номерах телефонов и именах отправителей из WhatsApp API.

## Проблема

В базе данных в таблицах `sellers` и `offers` вместо нормальных номеров телефонов и имен сохранены WhatsApp ID (длинные числовые строки типа `120363046456598557`).

## Решение

Утилита использует WhatsApp Web.js API для получения информации о контактах и обновляет записи в БД.

## Использование

### Вариант 1: Стенд-алон утилита (рекомендуется)

Запускается отдельно, сама инициализирует WhatsApp клиент:

```bash
cd whatsapp-service
npm run restore-contacts
```

Или напрямую:

```bash
node restore-contacts-standalone.js
```

### Вариант 2: Через API (если WhatsApp сервис уже запущен)

Добавить API endpoint в `web-server.js` для запуска восстановления через веб-интерфейс.

## Настройка

Перед запуском убедитесь, что в `.env` файле указаны параметры подключения к БД Spring Boot:

```env
SPRING_DB_HOST=localhost
SPRING_DB_PORT=5432
SPRING_DB_NAME=miners
SPRING_DB_USER=postgres
SPRING_DB_PASSWORD=vasagaroot
```

Или используйте переменные окружения при запуске:

```bash
SPRING_DB_NAME=shopdb SPRING_DB_PASSWORD=your_password npm run restore-contacts
```

## Что делает утилита

1. **Подключается к WhatsApp** (потребуется отсканировать QR-код)
2. **Подключается к БД Spring Boot** (PostgreSQL)
3. **Находит записи с WhatsApp ID** вместо нормальных данных:
   - В таблице `sellers`: где `name` или `phone` содержат длинные числовые строки
   - В таблице `offers`: где `seller_name` или `seller_phone` содержат длинные числовые строки
4. **Получает информацию о контактах** через WhatsApp API:
   - Номер телефона (`contact.number`)
   - Имя (`contact.name` или `contact.pushname`)
   - WhatsApp ID (`contact.id._serialized`)
5. **Обновляет записи в БД** с достоверной информацией

## Логика определения WhatsApp ID

Строка считается WhatsApp ID, если:
- Длина больше 12 символов
- Содержит только цифры
- Или имеет формат с `@` (например, `120363046456598557@c.us`)

## Ограничения

- Нужно активное подключение к WhatsApp
- Контакт должен быть доступен (не удален, не заблокирован)
- Для некоторых контактов информация может быть недоступна
- Утилита обрабатывает до 1000 записей за раз (можно изменить в коде)

## Результаты

Утилита выводит статистику:
- ✅ Обновлено: количество успешно обновленных записей
- ⚠️ Пропущено: записи, которые не требовали обновления
- ❌ Ошибок: записи, для которых не удалось получить информацию

