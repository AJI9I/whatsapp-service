# WhatsApp Service

Сервис для мониторинга групповых чатов и личных сообщений WhatsApp с веб-интерфейсом управления и отправкой сообщений в API.

## Возможности

- ✅ Подключение к WhatsApp Web через QR-код
- ✅ Автоматическое сохранение сессии (не нужно сканировать QR каждый раз)
- ✅ **Веб-интерфейс для управления** с выбором групп и чатов для мониторинга
- ✅ Мониторинг выбранных групповых чатов и/или личных сообщений
- ✅ Настройка API URL через веб-интерфейс
- ✅ Отправка сообщений в Spring Boot API через HTTP webhook
- ✅ Retry логика при ошибках отправки
- ✅ Логирование всех событий
- ✅ Поддержка медиафайлов (фото, документы)
- ✅ Real-time статус подключения и QR-код в интерфейсе

## Установка

1. Установите зависимости:
```bash
npm install
```

2. Создайте файл `.env` на основе `env.example`:
```bash
cp env.example .env
```

3. Настройте `.env` файл:
```env
API_URL=http://localhost:8050
API_ENDPOINT=/api/webhook/whatsapp
MONITORED_GROUPS=120363123456789@g.us,Продажа ASIC
LOG_LEVEL=info
```

## Использование

Запустите сервис:
```bash
npm start
```

Откройте веб-интерфейс:
```
http://localhost:3000
```

### Подключение WhatsApp:

1. Откройте веб-интерфейс в браузере
2. QR-код автоматически появится на главной странице
3. Отсканируйте QR-код через WhatsApp:
   - Откройте WhatsApp на телефоне
   - Настройки → Связанные устройства → Привязать устройство
   - Отсканируйте QR-код

После первого подключения сессия сохранится и QR-код больше не потребуется.

### Настройка через веб-интерфейс:

1. **Настройка API**: Укажите URL и endpoint вашего API в разделе "Настройки API"
2. **Выбор групп**: 
   - Нажмите "Обновить" для загрузки списка групп
   - Выберите группы для мониторинга (или включите "Мониторить все группы")
   - Нажмите "Сохранить выбор"
3. **Выбор личных чатов**: Аналогично настройте личные чаты
4. Все изменения сохраняются автоматически

## Конфигурация

### Веб-интерфейс (рекомендуется)

Все настройки можно изменить через веб-интерфейс на `http://localhost:3000`:
- Настройки API (URL, endpoint, API key)
- Выбор групп для мониторинга
- Выбор личных чатов для мониторинга

Конфигурация сохраняется в файл `monitoring-config.json`.

### Переменные окружения (опционально, для начальной конфигурации)

- `API_URL` - URL Spring Boot приложения (по умолчанию: `http://localhost:8050`)
- `API_ENDPOINT` - Endpoint для отправки сообщений (по умолчанию: `/api/webhook/whatsapp`)
- `API_KEY` - Опциональный API ключ для авторизации
- `SESSION_PATH` - Путь для сохранения сессии (по умолчанию: `./.wwebjs_auth`)
- `WEB_PORT` - Порт веб-интерфейса (по умолчанию: `3000`)
- `LOG_LEVEL` - Уровень логирования: `error`, `warn`, `info`, `debug` (по умолчанию: `info`)
- `RETRY_ATTEMPTS` - Количество попыток retry при ошибке (по умолчанию: `3`)
- `RETRY_DELAY` - Задержка между попытками в миллисекундах (по умолчанию: `5000`)

## Формат данных, отправляемых в API

При получении сообщения сервис отправляет POST запрос на указанный endpoint со следующим форматом:

```json
{
  "messageId": "true_120363123456789@g.us_3EB0...",
  "chatId": "120363123456789@g.us",
  "chatName": "Продажа ASIC майнеров",
  "senderId": "5511999999999@c.us",
  "senderName": "Иван Петров",
  "senderPhoneNumber": "5511999999999",
  "content": "Продам Москва Б/У:\n1)S19j PRO 104T, 1шт. 270u;...",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "hasMedia": false,
  "mediaUrl": null,
  "mediaMimetype": null,
  "mediaFilename": null,
  "mediaData": null,
  "messageType": "chat",
  "isForwarded": false
}
```

Если в сообщении есть медиафайл, будут заполнены поля:
- `hasMedia`: `true`
- `mediaMimetype`: например, `"image/jpeg"`
- `mediaFilename`: имя файла (если есть)
- `mediaData`: base64 строка с содержимым файла

## Структура проекта

```
whatsapp-service/
├── index.js              # Основной файл, инициализация приложения
├── whatsapp-client.js    # Модуль WhatsApp клиента
├── message-handler.js    # Обработчик входящих сообщений
├── config-manager.js     # Управление конфигурацией мониторинга
├── web-server.js         # Express веб-сервер и API
├── api-client.js         # HTTP клиент для отправки в Spring Boot API
├── config.js             # Конфигурация из .env
├── logger.js             # Настройка логирования (Winston)
├── package.json          # Зависимости проекта
├── public/               # Веб-интерфейс
│   ├── index.html       # HTML страница
│   └── app.js           # JavaScript для интерфейса
├── env.example           # Пример конфигурации
├── .gitignore           # Игнорируемые файлы
└── README.md            # Документация
```

## Логирование

Логи сохраняются в:
- Консоль (с цветами)
- `logs/combined.log` - все логи
- `logs/error.log` - только ошибки

## Troubleshooting

### QR-код не появляется
- Проверьте подключение к интернету
- Убедитесь, что порты не заблокированы

### Ошибка отправки в API
- Проверьте, что Spring Boot приложение запущено
- Проверьте правильность `API_URL` и `API_ENDPOINT`
- Убедитесь, что API принимает POST запросы на указанном endpoint

### Сессия не сохраняется
- Проверьте права на запись в директорию проекта
- Убедитесь, что `.wwebjs_auth` не в `.gitignore` (нужно сохранять сессию локально)

## Примечания

- Сервис должен работать постоянно для мониторинга сообщений
- Рекомендуется запускать через PM2 или systemd для автозапуска
- WhatsApp может ограничивать частоту отправки сообщений при большом объеме
